# 商城项目笔记

[TOC]



## 1.项目搭建

### 1.1虚拟机

软件使用`VMware® Workstation 15 Pro`，版本`15.5.1 build-15018445`

镜像使用`CentOS-7-x86_64-Minimal-1908.iso`（docker安装需要）

因为之前的笔记比较散，所以这里尽量做最全面的部署说明：



#### 1.1.1安装

这个镜像就是最小镜像，所以没有图形化界面：

进入界面，选择`Install CentOs7`之后随便选。

设定root密码123456



#### 1.1.2网络配置

首先需要查看当前虚拟机网关的地址，具体位置：

`控制面板\网络和 Internet\网络连接`

查看VMnet8的网关地址



也可以直接在管理员模式下启动Vmware，然后点击菜单->编辑->虚拟网络编辑器里面查看

```shell
编辑
vim /etc/sysconfig/network-scripts/ifcfg-ens33 

内容
......
BOOTPROTO=static
NAME=ens33
DEVICE=ens33
ONBOOT=yes
IPADDR=192.168.190.200
NETMASK=255.255.255.0
GATEWAY=这里就是网关地址
DNS1=8.8.8.8

重启
service network restart
```



如果是复制的机器，建议在开启的时候直接选择移动的机器，然后修改ip地址即可，如果选择复制，可能需要设计网卡的修改。



#### 1.1.3Docker安装

参考官网：https://docs.docker.com/install/linux/docker-ce/centos/

安装需要CentOs7主版本

docker包含 EE企业版本和CE社区版本。



官网关于stable/nightly/test三个更新渠道的说明

> - **Stable** gives you latest releases for general availability.
> - **Test** gives pre-releases that are ready for testing before general availability.
> - **Nightly** gives you latest builds of work in progress for the next major release.





##### 1.1.3.1使用Docker Repository来安装

官网推荐设置Docker repository来安装：



- 删除旧版本

```shell
$ sudo yum remove docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-engine
```



- 安装`yum-utils`包（提供`yum-config-manager`功能）并设定稳定的仓库

```shell
$ sudo yum install -y yum-utils

$ sudo yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo
```



- 官方建议安装nightly或者test更新渠道

```shell
开启nightly repository
$ sudo yum-config-manager --enable docker-ce-nightly

启动test
$ sudo yum-config-manager --enable docker-ce-test

关闭nightly或者test使用--disable即可
$ sudo yum-config-manager --disable docker-ce-nightly
```



- 安装特定版本

```shell
查看版本列表
$ sudo yum list docker-ce --showduplicates | sort -r

docker-ce.x86_64  3:18.09.1-3.el7                     docker-ce-stable
docker-ce.x86_64  3:18.09.0-3.el7                     docker-ce-stable
docker-ce.x86_64  18.06.1.ce-3.el7                    docker-ce-stable
docker-ce.x86_64  18.06.0.ce-3.el7                    docker-ce-stable

安装时候使用docker-ce加上版本号，如docker-ce-18.06.0.ce('-'前面为版本号)
$ sudo yum install docker-ce-<VERSION_STRING> docker-ce-cli-<VERSION_STRING> containerd.io
```



- 安装最新版本

```shell
$ sudo yum install docker-ce docker-ce-cli containerd.io
```



- 启动

```shell
$ sudo systemctl start docker
```



- 测试

```shell
$ sudo docker run hello-world
```



##### 1.1.3.2使用安装包

- 下载版本 https://download.docker.com/linux/centos/7/x86_64/ 选择安装版本
- 安装：`yum install /path/to/package.rpm`
- 启动：`systemctl start docker`
- 测试：`docker run hello-world`



##### 1.1.3.3使用阿里docker社区版yum源安装

```shell
 # 安装wget
 yum install wget
 
 # 下载阿里云docker社区版yum源
 cd /etc/yum.repos.d/
 wget http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
 
 # 查看docker安装包
 yum list | grep docker
 
 # 安装docker ce社区版本
 yum install -y docker-ce.x86_64
 
 # 设置开机启动
 systemctl enable docker
 
 # 更新xfsprogs
 yum -y update xfsprogs
 
 # 启动docker
 systemctl start docker

 # 查看版本
 docker version
 
 # 查看详细信息
 docker info
```



#### 1.1.4设置Docker容器自动启动

```shell
docker update --restart=always CONTAINER_NAME/CONTAINER_ID
```





### 1.2数据库

### 1.3代码结构

#### 1.3.1父工程

父工程主要负责导入springboot、springcloud



> parent标签主要用于实现复用父类的依赖以及统一管理依赖的版本号。

## 2. fastDfs

### 2.1Docker安装fastDfs

- 拉取镜像：

  ```shell
  docker pull morunchang/fastdfs
  
  #因为拉取太慢了，我也不知道能不能拉下来，所以从其他虚拟机拷贝的
  #保存压缩镜像到本地
  docker save a729ac95698a | gzip > fastdfs.tar.gz
  #发送到安装机器
  scp fastdfs.tar.gz root@192.168.190.200:/root
  #解压并加载到本地仓库
  gunzip -c fastdfs.tar.gz | docker load
  #重命名
  docker tag a729ac95698a morunchang/fastdfs
  ```

  

- 运行tracker：

  ```shell
  docker run -d --name tracker --net=host morunchang/fastdfs sh tracker.sh
  --net:使用的网路模式为host，也就是共享主机network namespace可以直接访问主机的网络信息，缺点是两个容器的端口必须不同，因为都是使用主机的接口。
  ```

  

- 运行storage：

  ```shell
docker run -d --name storage --net=host -e TRACKER_IP=<your tracker server address>:22122 -e GROUP_NAME=<group name> morunchang/fastdfs sh storage.sh
  
  --net:使用的网路模式为host，也就是共享主机network namespace可以直接访问主机的网络信息，缺点是两个容器的端口必须不同，因为都是使用主机的接口。
  -e添加到环境变量
  	TRACKER_IP  track机器的ip
  	GROUP_NAME	组名，也就是storage的组，新的storage服务器组名需要改变
  
  
  #本例使用
  docker run -d --name storage --net=host -e TRACKER_IP=192.168.190.200:22122 -e GROUP_NAME=group1 morunchang/fastdfs sh storage.sh
  ```
  
  
  
- storage内部修改nginx配置

  ```shell
  #进入容器
  docker exec -it storage /bin/bash
  #修改nginx配置
  vim /etc/nginx/conf/nginx.conf
  
  #里面已经有配置了，nginx端口8080
  location ~ /M00 {
  	root /data/fast_data/data;
      ngx_fastdfs_module;
  }
  #如果不希望浏览器缓存的话（比如删除希望立即删除）
  add_header Cache-Control no-store;
  
  #退出容器
  exit
  
  #重启storage容器
  docker restart storage
  ```



- 查看启动的容器：`docker ps`

- 开机启动设置：

  ```shell
  docker update --restart=always tracker
  docker update --restart=always storage
  ```

- 查看配置文件

  ```shell
  docker exec -it storage /bin/bash
  cd /etc/fdfs/
  vim storage.conf
  #里面的store_path0表示文件的位置
  store_path0=/data/fast_data
  #tracker的地址
  tracker_server=192.168.211.132:22122
  ```

  

### 2.2fastDfs服务代码

看了几个不同的项目，基本都是使用github上面的这个项目： https://github.com/happyfish100/fastdfs-client-java

文档里面写得很清楚了，使用idea的话install一下就可以了。

安装到本地库之后使用pom导入（注意版本号和编译的一样）：

```xml
        <dependency>
            <groupId>org.csource</groupId>
            <artifactId>fastdfs-client-java</artifactId>
            <version>1.29-SNAPSHOT</version>
        </dependency>
```





验证文件：

```shell
#进入容器
docker exec -it storage /bin/bash

cd /etc/fdfs/
```





## 3.常见问题





## 4.



