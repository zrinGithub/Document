# TCP 三次握手四次挥手

## 1. 相关博客

掘金博客：猿人谷：[面试官，不要再问我三次握手和四次挥手](https://juejin.im/post/5d9c284b518825095879e7a5)





## 2. 图解 

- 11种状态图:

![TCP11种状态图](.\images\TCP11种状态图.png)



- 三次握手四次挥手

![TCP三次握手四次挥手](.\images\TCP三次握手四次挥手.png)

## 3. 三次握手



<img src=".\images\三次握手状态切换图.jpg" alt="三次握手状态切换图" style="zoom: 50%;" />

- 作用

  - 双方（客户端与服务端）都要确认双方的接收能力和发送能力是否正常，也就是说有四个能力需要确定。

- 如果使用两次握手会发生什么？

  - 客户端发送的第一次请求`request A`因为网络原因长时间滞留
  - 客户端重发连接请求，服务器收到
  - 如果只有两次握手，服务器收到发送确认请求，连接建立
  - 服务器收到延迟的请求`request A`，认为客户端有新的请求，又发送确认信息
  - 客户端忽略服务器的第二次确认信息
  - 服务器一直等待数据

- 前两次握手不能携带数据
  - 防止恶意攻击服务器

- SYN攻击

  -  Client在短时间内伪造大量不存在的IP地址，并向Server不断地发送SYN包引起网络拥塞。 

  - 检测： `netstat -n -p TCP | grep SYN_RECV` 





![四次挥手](.\images\三次握手-连接队列.png)

## 4. 四次挥手

![四次挥手](.\images\四次挥手.jpg)

- TCP四次挥手是什么吗？为什么要进行四次挥手
  - 确保数据能够完整传输
    - 当被动方收到主动方的FIN报文通知时，它仅仅表示主动方没有数据再发送给被动方了。
    - 但未必被动方所有的数据都完整的发送给了主动方，所以被动方不会马上关闭SOCKET,它可能还需要发送一些数据给主动方后，再发送FIN报文给主动方，告诉主动方同意关闭连接
    - 所以这里的ACK报文和FIN报文多数情况下都是分开发送的。

- TCP第11种状态CLOSING 状态概念

  - 这种状态在实际情况中应该很少见，属于一种比较罕见的例外状态。正常情况下，当一方发送FIN报文后，按理来说是应该先收到（或同时收到）对方的ACK报文，再收到对方的FIN报文。但是CLOSING 状态表示一方发送FIN报文后，并没有收到对方的ACK报文，反而却也收到了对方的FIN报文。什么情况下会出现此种情况呢？那就是当双方几乎在同时close()一个SOCKET的话，就出现了双方同时发送FIN报文的情况，这是就会出现CLOSING 状态，表示双方都正在关闭SOCKET连接。

   

   